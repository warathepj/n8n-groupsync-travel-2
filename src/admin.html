<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <a href="/">Home</a>
    <div id="dataContainer"></div>
    <button id="sendButton">ให้ AI จัดทริปให้คุณ</button>
    <div id="webhookResponse"></div>
<!-- render webhook response -->
    <script>
        function formatText(text) {
            const words = text.split(' ');
            let formattedText = '';
            let lineCount = 0;
            let currentLineWords = [];

            let currentWordCount = 0;
            let currentLine = '';
            let lines = [];

            for (let i = 0; i < words.length; i++) {
                currentLine += (currentLine === '' ? '' : ' ') + words[i];
                currentWordCount++;

                if (currentWordCount === 20 || i === words.length - 1) {
                    lines.push(currentLine);
                    currentLine = '';
                    currentWordCount = 0;
                }
            }

            let finalFormattedText = '';
            for (let i = 0; i < lines.length; i++) {
                finalFormattedText += lines[i] + '<br>';
                if ((i + 1) % 3 === 0 && i !== lines.length - 1) {
                    finalFormattedText += '<br>'; // Add a blank line
                }
            }
            return finalFormattedText;
        }

        fetch('./data.json')
            .then(response => response.json())
            .then(data => {
                const dataContainer = document.getElementById('dataContainer');
                data.forEach(item => {
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <p><strong>Name:</strong> ${item.name}</p>
                        <p><strong>Travel Date:</strong> ${item.travel_date}</p>
                        <p><strong>Destination:</strong> ${item.destination}</p>
                        <hr>
                    `;
                    dataContainer.appendChild(div);
                });
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });

        document.getElementById('sendButton').addEventListener('click', () => {
            fetch('/send-to-webhook', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                // No body needed here, as the server will read data.json
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(data => {
                const webhookResponse = document.getElementById('webhookResponse');
                try {
                    const jsonStartIndex = data.indexOf('{');
                    if (jsonStartIndex !== -1) {
                        const jsonString = data.substring(jsonStartIndex);
                        const jsonResponse = JSON.parse(jsonString);
                        if (jsonResponse.text) {
                            webhookResponse.innerHTML = 'Server response: <br>' + formatText(jsonResponse.text);
                        } else {
                            webhookResponse.textContent = 'Server response (parsed, no text field): ' + data;
                        }
                    } else {
                        webhookResponse.textContent = 'Server response (raw): ' + data;
                    }
                } catch (e) {
                    console.error('Error parsing JSON:', e);
                    webhookResponse.textContent = 'Server response (error parsing): ' + data;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const webhookResponse = document.getElementById('webhookResponse');
                webhookResponse.textContent = 'Failed to trigger server: ' + error.message;
            });
        });
    </script>
</body>
</html>
